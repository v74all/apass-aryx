<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Job - APASS ARYX</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='APASS_ARIX.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-enhanced.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
</head>
<body>
    
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="{{ url_for('static', filename='APASS_ARIX.png') }}" alt="APASS ARYX Logo" class="nav-logo">
                <h1>APASS ARYX</h1>
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link"><i class="fas fa-home"></i> Home</a>
                <a href="/jobs" class="nav-link active"><i class="fas fa-history"></i> Job History</a>
                <a href="/status" class="nav-link"><i class="fas fa-chart-line"></i> System Status</a>
                <a href="/compare" class="nav-link"><i class="fas fa-balance-scale"></i> Compare</a>
            </div>
        </div>
    </nav>

    
    <div class="development-notice">
        <div class="notice-container">
            <i class="fas fa-exclamation-triangle"></i>
            <span><strong>Beta v1 - Under Development:</strong> This software is currently in development. Features may be incomplete or subject to change.</span>
            <i class="fas fa-code"></i>
        </div>
    </div>

    <main>
        <div class="container">
            
            <div class="job-header-section">
                <div class="job-title">
                    <div class="job-navigation">
                        <a href="/" class="btn secondary back-btn">
                            <i class="fas fa-arrow-left"></i>
                            Back to Home
                        </a>
                        <a href="/jobs" class="btn secondary back-btn">
                            <i class="fas fa-list"></i>
                            All Jobs
                        </a>
                    </div>
                    <h1><i class="fas fa-file-code"></i> Analysis Job</h1>
                    <p class="job-id">Job ID: <code>{{ job.id }}</code></p>
                </div>
                
                <div class="job-actions">
                    {% if job.status == "running" %}
                        <button class="btn danger" onclick="cancelJob('{{ job.id }}')" id="cancel-btn">
                            <i class="fas fa-stop"></i>
                            Cancel Job
                        </button>
                    {% elif job.status == "completed" and job.type == "single" %}
                        <a href="{{ url_for('compare_jobs') }}?job1={{ job.id }}" class="btn primary">
                            <i class="fas fa-balance-scale"></i>
                            Compare Results
                        </a>
                    {% endif %}
                    
                    {% if job.status not in ["running"] %}
                        <button class="btn danger" onclick="deleteJob('{{ job.id }}')" id="delete-btn">
                            <i class="fas fa-trash"></i>
                            Delete Job
                        </button>
                    {% endif %}
                    
                    <button class="btn secondary" onclick="refreshJobStatus()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
            </div>

            
            <div class="status-banner {{ job.status }}">
                <div class="status-content">
                    <div class="status-icon">
                        {% if job.status == "running" %}
                            <i class="fas fa-spinner fa-spin"></i>
                        {% elif job.status == "completed" %}
                            <i class="fas fa-check-circle"></i>
                        {% elif job.status in ["failed", "error"] %}
                            <i class="fas fa-exclamation-circle"></i>
                        {% elif job.status == "cancelled" %}
                            <i class="fas fa-ban"></i>
                        {% else %}
                            <i class="fas fa-clock"></i>
                        {% endif %}
                    </div>
                    <div class="status-info">
                        <h2>{{ job.status.title() }}</h2>
                        {% if job.status == "running" %}
                            <p>Analysis is currently in progress</p>
                        {% elif job.status == "completed" %}
                            <p>Analysis completed successfully</p>
                        {% elif job.status in ["failed", "error"] %}
                            <p>Analysis failed - check logs for details</p>
                        {% elif job.status == "cancelled" %}
                            <p>Analysis was cancelled by user</p>
                        {% endif %}
                    </div>
                    
                    
                    {% if job.status == "running" %}
                        <div class="progress-section">
                            <div class="progress-content">
                                <div class="progress-bar">
                                    <div class="progress" id="progress-bar" 
                                         data-progress="{{ job.progress or 0 }}" 
                                         data-current-task="{{ job.current_task or 'Starting analysis...' }}"></div>
                                </div>
                                <div class="progress-text" id="progress-text">
                                    {% if job.current_icon %}<i class="{{ job.current_icon }}"></i>{% endif %}
                                    {{ job.progress or 0 }}% Complete â€” {{ job.current_task or 'Starting analysis...' }}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            
            <div class="job-info-grid">
                
                <div class="info-card">
                    <div class="card-header">
                        <h3><i class="fas fa-info-circle"></i> Job Information</h3>
                    </div>
                    <div class="card-content">
                        <div class="info-row">
                            <span class="label">Job ID:</span>
                            <span class="value">{{ job.id }}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Type:</span>
                            <span class="value">
                                <span class="job-type-badge {{ job.type }}">
                                    {% if job.type == 'single' %}
                                        <i class="fas fa-file-archive"></i> Single APK
                                    {% else %}
                                        <i class="fas fa-layer-group"></i> Batch Analysis
                                    {% endif %}
                                </span>
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="label">Engine:</span>
                            <span class="value">{{ job.engine }}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Created:</span>
                            <span class="value">{{ job.created_at|format_datetime }}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Duration:</span>
                            <span class="value">{{ job.created_at|format_duration(job.updated_at) }}</span>
                        </div>
                        {% if job.get('result') is not none %}
                        <div class="info-row">
                            <span class="label">Exit Code:</span>
                            <span class="value {{ 'success' if job.result == 0 else 'error' }}">{{ job.result }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                
                {% if job.get('options') %}
                <div class="info-card">
                    <div class="card-header">
                        <h3><i class="fas fa-sliders-h"></i> Selected Options</h3>
                    </div>
                    <div class="card-content">
                        {% if job.type == 'single' %}
                            <div class="info-row">
                                <span class="label">Analysis Depth:</span>
                                <span class="value">{{ job.options.get('analysis_depth', 'standard')|title }}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Dynamic Analysis:</span>
                                <span class="value {{ 'success' if job.options.get('enable_dynamic') else 'text-muted' }}">{{ 'Enabled' if job.options.get('enable_dynamic') else 'Disabled' }}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Static Analysis:</span>
                                <span class="value {{ 'success' if job.options.get('enable_static') else 'text-muted' }}">{{ 'Enabled' if job.options.get('enable_static') else 'Disabled' }}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Network Analysis:</span>
                                <span class="value {{ 'success' if job.options.get('enable_network') else 'text-muted' }}">{{ 'Enabled' if job.options.get('enable_network') else 'Disabled' }}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Malware Detection:</span>
                                <span class="value {{ 'success' if job.options.get('enable_malware') else 'text-muted' }}">{{ 'Enabled' if job.options.get('enable_malware') else 'Disabled' }}</span>
                            </div>
                        {% else %}
                            <div class="info-row">
                                <span class="label">Processing Mode:</span>
                                <span class="value">{{ job.options.get('batch_mode', 'parallel')|title }}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Continue on Error:</span>
                                <span class="value {{ 'success' if job.options.get('continue_on_error') else 'text-muted' }}">{{ 'Yes' if job.options.get('continue_on_error') else 'No' }}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Summary Report:</span>
                                <span class="value {{ 'success' if job.options.get('generate_summary') else 'text-muted' }}">{{ 'Enabled' if job.options.get('generate_summary') else 'Disabled' }}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Email Notification:</span>
                                <span class="value {{ 'success' if job.options.get('email_notification') else 'text-muted' }}">{{ 'Enabled' if job.options.get('email_notification') else 'Disabled' }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                
                <div class="info-card">
                    <div class="card-header">
                        <h3>
                            {% if job.type == 'single' %}
                                <i class="fas fa-file-archive"></i> File Information
                            {% else %}
                                <i class="fas fa-files"></i> Files Information
                            {% endif %}
                        </h3>
                    </div>
                    <div class="card-content">
                        {% if job.type == 'single' %}
                            <div class="info-row">
                                <span class="label">Filename:</span>
                                <span class="value">{{ job.filename }}</span>
                            </div>
                        {% else %}
                            <div class="info-row">
                                <span class="label">Total Files:</span>
                                <span class="value>{{ job.file_count }}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Completed:</span>
                                <span class="value success">{{ job.get('completed', 0) }}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Failed:</span>
                                <span class="value error">{{ job.get('failed', 0) }}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Success Rate:</span>
                                <span class="value">
                                    {% if job.get('completed', 0) + job.get('failed', 0) > 0 %}
                                        {{ "%.1f"|format((job.get('completed', 0) / (job.get('completed', 0) + job.get('failed', 0))) * 100) }}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </span>
                            </div>
                        {% endif %}
                    </div>
                </div>

                
                {% if job.status in ["completed", "failed", "error"] %}
                <div class="info-card">
                    <div class="card-header">
                        <h3><i class="fas fa-cog"></i> Execution Details</h3>
                    </div>
                    <div class="card-content">
                        {% if job.get('outdir') %}
                        <div class="info-row">
                            <span class="label">Output Directory:</span>
                            <span class="value"><code>{{ job.outdir }}</code></span>
                        </div>
                        {% endif %}
                        {% if job.get('error') %}
                        <div class="info-row">
                            <span class="label">Error:</span>
                            <span class="value error">{{ job.error }}</span>
                        </div>
                        {% endif %}
                        <div class="info-row">
                            <span class="label">Last Updated:</span>
                            <span class="value">{{ job.updated_at|format_datetime }}</span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            
            {% if job.status == "completed" and job.get('reports') %}
                <div class="reports-section">
                    <div class="section-header">
                        <h2><i class="fas fa-file-alt"></i> Analysis Reports</h2>
                        <p>Generated reports from the analysis with detailed explanations</p>
                    </div>
                    
                    
                    <div class="analysis-summary">
                        <div class="summary-cards">
                            <div class="summary-card">
                                <div class="summary-icon"><i class="fas fa-shield-alt summary-icon-primary"></i></div>
                                <div class="summary-title">Overall Security Score</div>
                                <div class="summary-value summary-value-primary">{{ job.get('security_score', '85') }}/100</div>
                                <div class="summary-description">Based on combined analysis factors</div>
                            </div>
                            
                            <div class="summary-card">
                                <div class="summary-icon"><i class="fas fa-bug summary-icon-error"></i></div>
                                <div class="summary-title">Vulnerabilities</div>
                                <div class="summary-value summary-value-error">{{ job.get('vulnerabilities_count', '3') }}</div>
                                <div class="summary-description">Potential security issues found</div>
                            </div>
                            
                            <div class="summary-card">
                                <div class="summary-icon"><i class="fas fa-user-secret summary-icon-warning"></i></div>
                                <div class="summary-title">Privacy Concerns</div>
                                <div class="summary-value summary-value-warning">{{ job.get('privacy_issues', '2') }}</div>
                                <div class="summary-description">Data collection or tracking concerns</div>
                            </div>
                            
                            <div class="summary-card">
                                <div class="summary-icon"><i class="fas fa-check-circle summary-icon-success"></i></div>
                                <div class="summary-title">Analysis Duration</div>
                                <div class="summary-value summary-value-success">{{ job.created_at|format_duration(job.updated_at) }}</div>
                                <div class="summary-description">Total processing time</div>
                            </div>
                        </div>
                        
                        
                        <div class="risk-gauge-container">
                            <h3>Risk Assessment</h3>
                            <div class="risk-gauge">
                                <div class="gauge-background"></div>
                                {% set risk_level = job.get('risk_level', 25) %}
                                <div class="gauge-fill {% if risk_level < 20 %}gauge-fill-low{% elif risk_level < 40 %}gauge-fill-medium-low{% elif risk_level < 60 %}gauge-fill-medium{% elif risk_level < 80 %}gauge-fill-medium-high{% elif risk_level < 90 %}gauge-fill-high{% else %}gauge-fill-critical{% endif %}"></div>
                                <div class="gauge-needle {% if risk_level < 20 %}gauge-needle-low{% elif risk_level < 40 %}gauge-needle-medium-low{% elif risk_level < 60 %}gauge-needle-medium{% elif risk_level < 80 %}gauge-needle-medium-high{% elif risk_level < 90 %}gauge-needle-high{% else %}gauge-needle-critical{% endif %}"></div>
                                <div class="gauge-labels">
                                    <div>Low</div>
                                    <div>Medium</div>
                                    <div>High</div>
                                </div>
                                <div class="gauge-value">{{ risk_level }}%</div>
                            </div>
                            <p class="risk-explanation">
                                {% if job.get('risk_level', 25) < 33 %}
                                    This application shows a low risk profile with minimal security or privacy concerns.
                                {% elif job.get('risk_level', 25) < 66 %}
                                    This application shows a moderate risk profile with some security or privacy concerns that should be reviewed.
                                {% else %}
                                    This application shows a high risk profile with significant security or privacy concerns that require immediate attention.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    
                    <div class="analysis-result-section">
                        <div class="analysis-result-header">
                            <h3><i class="fas fa-microscope"></i> Detailed Analysis Results</h3>
                            <div class="tooltip" data-tooltip="Click on any result card to see detailed explanation and recommendations">
                                <i class="fas fa-info-circle"></i>
                            </div>
                        </div>
                        
                        <div class="analysis-result-grid">
                            
                            <div class="analysis-result" data-category="permissions" data-risk="medium">
                                <div class="analysis-result-icon medium">
                                    <i class="fas fa-key"></i>
                                </div>
                                <div class="analysis-result-title">Permissions Analysis</div>
                                <div class="analysis-result-score medium">B</div>
                                <div class="analysis-result-details">
                                    Uses 14 permissions, including 3 dangerous permissions that access sensitive data
                                </div>
                                
                            </div>
                            
                            <div class="analysis-result" data-category="code_signatures" data-risk="low">
                                <div class="analysis-result-icon low">
                                    <i class="fas fa-signature"></i>
                                </div>
                                <div class="analysis-result-title">Code Signatures</div>
                                <div class="analysis-result-score low">A</div>
                                <div class="analysis-result-details">
                                    Properly signed with valid certificate chain and signature verification
                                </div>
                                
                            </div>
                            
                            <div class="analysis-result" data-category="network_activity" data-risk="high">
                                <div class="analysis-result-icon high">
                                    <i class="fas fa-globe"></i>
                                </div>
                                <div class="analysis-result-title">Network Activity</div>
                                <div class="analysis-result-score high">D</div>
                                <div class="analysis-result-details">
                                    Detected unencrypted data transmission and connections to untrusted domains
                                </div>
                                
                            </div>
                            
                            <div class="analysis-result" data-category="vulnerabilities" data-risk="medium">
                                <div class="analysis-result-icon medium">
                                    <i class="fas fa-bug"></i>
                                </div>
                                <div class="analysis-result-title">Vulnerability Assessment</div>
                                <div class="analysis-result-score medium">C</div>
                                <div class="analysis-result-details">
                                    Found 3 moderate security issues in dependencies and application code
                                </div>
                                
                            </div>
                            
                            <div class="analysis-result" data-category="malware_signatures" data-risk="low">
                                <div class="analysis-result-icon low">
                                    <i class="fas fa-virus-slash"></i>
                                </div>
                                <div class="analysis-result-title">Malware Detection</div>
                                <div class="analysis-result-score low">A</div>
                                <div class="analysis-result-details">
                                    No matches to known malware signatures or suspicious code patterns
                                </div>
                                
                            </div>
                            
                            <div class="analysis-result" data-category="tracking" data-risk="medium">
                                <div class="analysis-result-icon medium">
                                    <i class="fas fa-eye"></i>
                                </div>
                                <div class="analysis-result-title">Tracking & Analytics</div>
                                <div class="analysis-result-score medium">C</div>
                                <div class="analysis-result-details">
                                    Uses multiple analytics SDKs and collects device identifiers
                                </div>
                                
                            </div>
                        </div>
                    </div>
                    
                    <div class="reports-grid">
                        {% for report_name, report_path in job.reports.items() %}
                            <div class="report-card">
                                <div class="report-icon">
                                    {% if report_name.endswith('.json') %}
                                        <i class="fas fa-code icon-json"></i>
                                    {% elif report_name.endswith('.txt') %}
                                        <i class="fas fa-file-alt icon-text"></i>
                                    {% elif report_name.endswith('.html') %}
                                        <i class="fas fa-globe icon-html"></i>
                                    {% elif report_name.endswith('.pdf') %}
                                        <i class="fas fa-file-pdf icon-pdf"></i>
                                    {% else %}
                                        <i class="fas fa-file icon-generic"></i>
                                    {% endif %}
                                </div>
                                <div class="report-info">
                                    <h4>{{ report_name }}</h4>
                                    <p class="report-type">
                                        {% if report_name.endswith('.json') %}
                                            JSON Report
                                        {% elif report_name.endswith('.txt') %}
                                            Text Report
                                        {% elif report_name.endswith('.html') %}
                                            HTML Report
                                        {% elif report_name.endswith('.pdf') %}
                                            PDF Report
                                        {% else %}
                                            Unknown Format
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="report-actions">
                                    <a href="{{ url_for('view_report', job_id=job.id, report_file=report_name) }}" 
                                       class="btn small primary" target="_blank" rel="noopener noreferrer">
                                        <i class="fas fa-eye"></i>
                                        View
                                    </a>
                                    <a href="{{ url_for('view_report', job_id=job.id, report_file=report_name) }}?download=1" 
                                       class="btn small secondary">
                                        <i class="fas fa-download"></i>
                                        Download
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            
            {% if job.type == 'batch' and job.get('results') %}
                <div class="batch-results-section">
                    <div class="section-header">
                        <h2><i class="fas fa-chart-bar"></i> Batch Results</h2>
                        <p>Individual file analysis results</p>
                    </div>
                    
                    <div class="batch-summary">
                        <div class="summary-card">
                            <div class="summary-value success">{{ job.get('completed', 0) }}</div>
                            <div class="summary-label">Completed</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value error">{{ job.get('failed', 0) }}</div>
                            <div class="summary-label">Failed</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value primary">{{ job.file_count }}</div>
                            <div class="summary-label">Total Files</div>
                        </div>
                    </div>

                    <div class="batch-results-table">
                        <table class="responsive-table">
                            <thead>
                                <tr>
                                    <th>File Name</th>
                                    <th>Status</th>
                                    <th>Result</th>
                                    <th>Completed At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for file_name, result in job.results.items() %}
                                    <tr class="result-row {{ result.status }}">
                                        <td data-label="File Name">
                                            <div class="file-name">
                                                <i class="fas fa-file-archive"></i>
                                                {{ file_name }}
                                            </div>
                                        </td>
                                        <td data-label="Status">
                                            <span class="status-badge {{ result.status }}">{{ result.status }}</span>
                                        </td>
                                        <td data-label="Result">
                                            {% if result.get('result') is not none %}
                                                <span class="result-code {{ 'success' if result.result == 0 else 'error' }}">
                                                    {{ result.result }}
                                                </span>
                                            {% elif result.get('error') %}
                                                <span class="error-text">{{ result.error }}</span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td data-label="Completed At">
                                            {% if result.get('completed_at') %}
                                                {{ result.completed_at|format_datetime }}
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td data-label="Actions">
                                            {% if result.status == 'completed' and result.get('reports') %}
                                                <div class="action-buttons">
                                                    {% for report in result.reports %}
                                                        <a href="{{ report }}" class="btn small primary" target="_blank" rel="noopener noreferrer">
                                                            <i class="fas fa-eye"></i>
                                                            View
                                                        </a>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">No actions</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}

            
            {% if job.get('log') %}
                <div class="activity-log-section">
                    <div class="section-header">
                        <h2><i class="fas fa-list"></i> Activity Log</h2>
                        <p>Detailed execution log</p>
                    </div>
                    
                    <div class="log-container">
                        <div class="log-entries">
                            {% for entry in job.log %}
                                <div class="log-entry">
                                    <div class="log-time">{{ entry.time|format_datetime }}</div>
                                    <div class="log-message">{{ entry.message }}</div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}

            
            <div class="quick-actions-section">
                <div class="section-header">
                    <h2><i class="fas fa-rocket"></i> Quick Actions</h2>
                </div>
                
                <div class="action-cards">
                    <a href="/" class="action-card">
                        <i class="fas fa-plus"></i>
                        <h3>New Analysis</h3>
                        <p>Start a new APK analysis</p>
                    </a>
                    
                    <a href="/jobs" class="action-card">
                        <i class="fas fa-history"></i>
                        <h3>View All Jobs</h3>
                        <p>Browse job history</p>
                    </a>
                    
                    {% if job.status == "completed" and job.type == "single" %}
                        <a href="{{ url_for('compare_jobs') }}?job1={{ job.id }}" class="action-card">
                            <i class="fas fa-balance-scale"></i>
                            <h3>Compare Results</h3>
                            <p>Compare with another job</p>
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </main>

    
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>APASS ARYX</h3>
                    <p>Advanced APK Analysis Platform for comprehensive security assessment</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="/">Home</a></li>
                        <li><a href="/jobs">Job History</a></li>
                        <li><a href="/status">System Status</a></li>
                        <li><a href="/compare">Compare Results</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 APASS ARYX by Aiden Azad (V7lthronyx). All rights reserved.</p>
            </div>
        </div>
    </footer>

    {% if job.status == "running" %}
    
    <div id="job-loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loader large"></div>
            <h3>Analysis in Progressâ€¦</h3>
            <p id="job-loading-message">Please keep this page open. You can navigate away; progress will be saved.</p>
            <div class="progress-container">
                <div class="progress-bar-wrapper">
                    <div id="job-analysis-progress" class="progress-bar" data-progress="{{ job.progress or 0 }}"></div>
                </div>
                <div id="job-progress-percentage">{{ job.progress or 0 }}%</div>
                <div id="job-progress-task" class="text-muted">{{ job.current_task or 'Starting analysis...' }}</div>
            </div>
            <div class="overlay-actions">
                <a href="/" class="btn secondary">
                    <i class="fas fa-arrow-left"></i> Back to Home
                </a>
                <a href="/jobs" class="btn secondary">
                    <i class="fas fa-list"></i> All Jobs
                </a>
                <button class="btn danger" onclick="cancelJob('{{ job.id }}')"><i class="fas fa-stop"></i> Cancel</button>
            </div>
        </div>
    </div>
    <script>
    // Keep overlay visible and synced while running
    (function(){
        const overlay = document.getElementById('job-loading-overlay');
        if (!overlay) return;
        
        // Job data from template (use tojson to safely embed values in JS)
        const jobId = "{{ job.id|tojson }}";
        const currentStatus = "{{ job.status|tojson }}";
        const initialProgress = parseInt("{{ job.progress|default(0) }}") || 0;
        const initialTask = "{{ (job.current_task or 'Starting analysis...')|tojson }}";
        
        // Show overlay immediately if job is running
        if (currentStatus === 'running') {
            overlay.classList.remove('is-hidden');
            overlay.style.display = 'flex';
        }
        
        function syncOverlay(data){
            const pct = document.getElementById('job-analysis-progress');
            const pctText = document.getElementById('job-progress-percentage');
            const task = document.getElementById('job-progress-task');
            
            if (pct && typeof data.progress === 'number') {
                const progressValue = Math.max(5, data.progress);
                pct.style.width = progressValue + '%';
                pct.setAttribute('data-progress', data.progress);
            }
            if (pctText && typeof data.progress === 'number') {
                pctText.textContent = Math.round(data.progress) + '%';
            }
            if (task && data.current_task) {
                task.textContent = data.current_task;
            }
            
            // Update main page progress as well
            const mainProgress = document.getElementById('progress-bar');
            const mainProgressText = document.getElementById('progress-text');
            if (mainProgress && typeof data.progress === 'number') {
                const progressValue = Math.max(5, data.progress);
                mainProgress.style.width = progressValue + '%';
                mainProgress.setAttribute('data-progress', data.progress);
            }
            if (mainProgressText && data.current_task) {
                mainProgressText.textContent = Math.round(data.progress || 0) + '% Complete â€” ' + data.current_task;
            }
        }
        
        async function poll(){
            try {
                const res = await fetch('/api/job/' + encodeURIComponent(jobId));
                const js = await res.json();
                if (js && js.success && js.data){
                    if (js.data.status === 'running' || js.data.status === 'pending'){
                        overlay.classList.remove('is-hidden');
                        overlay.style.display = 'flex';
                        syncOverlay(js.data);
                        setTimeout(poll, 2000); // Poll every 2 seconds
                    } else {
                        overlay.classList.add('is-hidden');
                        overlay.style.display = 'none';
                        // Reload page to show final results
                        setTimeout(function() { 
                            window.location.reload(); 
                        }, 1000);
                    }
                } else {
                    setTimeout(poll, 3000);
                }
            } catch(e){
                console.error('Polling error:', e);
                setTimeout(poll, 3003);
            }
        }
        
        // Initialize progress display
        syncOverlay({
            progress: initialProgress,
            current_task: initialTask
        });
        
        // Start polling after a short delay
        setTimeout(poll, 1000);
    })();
    </script>
    {% endif %}

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/job_enhanced.js') }}"></script>
    <script src="{{ url_for('static', filename='js/analysis_explanation.js') }}"></script>
</body>
</html>


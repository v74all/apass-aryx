<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job History - APASS ARYX</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='APASS_ARIX.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="csrf-token" content="{{ csrf_token() }}">
</head>
<body>
    
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="{{ url_for('static', filename='APASS_ARIX.png') }}" alt="APASS ARYX Logo" class="nav-logo">
                <h1>APASS ARYX</h1>
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link"><i class="fas fa-home"></i> Home</a>
                <a href="/jobs" class="nav-link active"><i class="fas fa-history"></i> Job History</a>
                <a href="/status" class="nav-link"><i class="fas fa-chart-line"></i> System Status</a>
                <a href="/compare" class="nav-link"><i class="fas fa-balance-scale"></i> Compare</a>
            </div>
        </div>
    </nav>

    
    <div class="development-notice">
        <div class="notice-container">
            <i class="fas fa-exclamation-triangle"></i>
            <span><strong>Beta v1 - Under Development:</strong> This software is currently in development. Features may be incomplete or subject to change.</span>
            <i class="fas fa-code"></i>
        </div>
    </div>

    <main>
        <div class="container">
            
            <div class="page-header">
                <div class="header-content">
                    <div class="header-info">
                        <h1><i class="fas fa-history"></i> Job History</h1>
                        <p>Track and manage all your analysis jobs</p>
                    </div>
                    <div class="header-actions">
                        <a href="/" class="btn primary">
                            <i class="fas fa-plus"></i>
                            New Analysis
                        </a>
                        <button class="btn secondary" onclick="refreshJobList()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn secondary" onclick="toggleFilters()">
                            <i class="fas fa-filter"></i>
                            Filters
                        </button>
                    </div>
                </div>
            </div>

            
            <div class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon running">
                            <i class="fas fa-spinner fa-pulse"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="running-count">
                                {{ jobs | selectattr('status', 'equalto', 'running') | list | length }}
                            </div>
                            <div class="stat-label">Running</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon completed">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="completed-count">
                                {{ jobs | selectattr('status', 'equalto', 'completed') | list | length }}
                            </div>
                            <div class="stat-label">Completed</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon failed">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="failed-count">
                                {{ jobs | selectattr('status', 'in', ['failed', 'error']) | list | length }}
                            </div>
                            <div class="stat-label">Failed</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon total">
                            <i class="fas fa-list"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="total-count">{{ jobs | length }}</div>
                            <div class="stat-label">Total Jobs</div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="filters-section is-hidden" id="filters-section">
                <div class="filters-container">
                    <div class="filter-group">
                        <label for="status-filter">Status:</label>
                        <select id="status-filter" onchange="applyFilters()">
                            <option value="">All Statuses</option>
                            <option value="running">Running</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="type-filter">Type:</label>
                        <select id="type-filter" onchange="applyFilters()">
                            <option value="">All Types</option>
                            <option value="single">Single APK</option>
                            <option value="batch">Batch Analysis</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="date-filter">Date Range:</label>
                        <select id="date-filter" onchange="applyFilters()">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <button class="btn secondary small" onclick="clearFilters()">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>
            </div>

            
            <div class="jobs-section">
                {% if jobs %}
                    
                    <div class="view-controls">
                        <div class="view-mode">
                            <button class="view-btn active" data-view="grid" onclick="toggleView('grid')">
                                <i class="fas fa-th-large"></i>
                                Grid
                            </button>
                            <button class="view-btn" data-view="table" onclick="toggleView('table')">
                                <i class="fas fa-list"></i>
                                Table
                            </button>
                        </div>
                        
                        <div class="sort-controls">
                            <label for="sort-by">Sort by:</label>
                            <select id="sort-by" onchange="applySorting()">
                                <option value="created_desc">Newest First</option>
                                <option value="created_asc">Oldest First</option>
                                <option value="status">Status</option>
                                <option value="type">Type</option>
                            </select>
                        </div>
                    </div>

                    
                    <div id="grid-view" class="jobs-grid">
                        {% for job in jobs %}
                            <div class="job-card" data-status="{{ job.status }}" data-type="{{ job.type }}" data-created="{{ job.created_at }}">
                                <div class="job-card-header">
                                    <div class="job-status-indicator {{ job.status }}">
                                        {% if job.status == "running" %}
                                            <i class="fas fa-spinner fa-spin"></i>
                                        {% elif job.status == "completed" %}
                                            <i class="fas fa-check-circle"></i>
                                        {% elif job.status in ["failed", "error"] %}
                                            <i class="fas fa-exclamation-circle"></i>
                                        {% elif job.status == "cancelled" %}
                                            <i class="fas fa-ban"></i>
                                        {% else %}
                                            <i class="fas fa-clock"></i>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="job-type-badge {{ job.type }}">
                                        {% if job.type == 'single' %}
                                            <i class="fas fa-file-archive"></i> Single
                                        {% else %}
                                            <i class="fas fa-layer-group"></i> Batch
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="job-card-content">
                                    <h3 class="job-id">{{ job.id }}</h3>
                                    
                                    {% if job.type == 'single' %}
                                        <p class="job-filename">
                                            <i class="fas fa-file"></i>
                                            {{ job.filename | truncate(30) }}
                                        </p>
                                    {% else %}
                                        <p class="job-file-count">
                                            <i class="fas fa-files"></i>
                                            {{ job.file_count }} files
                                        </p>
                                    {% endif %}
                                    
                                    <div class="job-metadata">
                                        <div class="metadata-item">
                                            <i class="fas fa-cog"></i>
                                            <span>{{ job.engine }}</span>
                                        </div>
                                        <div class="metadata-item">
                                            <i class="fas fa-clock"></i>
                                            <span>{{ job.created_at | format_datetime }}</span>
                                        </div>
                                    </div>
                                    
                                    
                                    {% if job.status == "running" %}
                                        <div class="job-progress">
                                            <div class="progress-bar">
                                                <div class="progress" data-progress="{{ job.progress }}"></div>
                                            </div>
                                            <div class="progress-text">{{ job.progress }}%</div>
                                        </div>
                                    {% endif %}
                                    
                                    
                                    {% if job.type == 'batch' and job.status in ['completed', 'failed'] %}
                                        <div class="batch-summary">
                                            <div class="summary-item success">
                                                <span class="summary-value">{{ job.get('completed', 0) }}</span>
                                                <span class="summary-label">Completed</span>
                                            </div>
                                            <div class="summary-item error">
                                                <span class="summary-value">{{ job.get('failed', 0) }}</span>
                                                <span class="summary-label">Failed</span>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="job-card-actions">
                                    <a href="{{ url_for('view_job', job_id=job.id) }}" class="btn primary small">
                                        <i class="fas fa-eye"></i>
                                        View Details
                                    </a>
                                    
                                    {% if job.status in ["running", "pending"] %}
                                        <button class="btn danger small" onclick="cancelJob('{{ job.id }}')">
                                            <i class="fas fa-stop"></i>
                                            Cancel
                                        </button>
                                    {% elif job.status == "completed" and job.type == "single" %}
                                        <a href="{{ url_for('compare_jobs') }}?job1={{ job.id }}" class="btn secondary small">
                                            <i class="fas fa-balance-scale"></i>
                                            Compare
                                        </a>
                                    {% endif %}
                                    
                                    {% if job.status not in ["running"] %}
                                        <button class="btn danger small" onclick="deleteJob('{{ job.id }}')">
                                            <i class="fas fa-trash"></i>
                                            Delete
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    
                    <div id="table-view" class="jobs-table is-hidden">
                        <div class="table-container">
                            <table class="responsive-table">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th>Job ID</th>
                                        <th>Type</th>
                                        <th>File(s)</th>
                                        <th>Engine</th>
                                        <th>Created</th>
                                        <th>Duration</th>
                                        <th>Progress</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="jobs-table-body">
                                    {% for job in jobs %}
                                        <tr class="job-row" data-status="{{ job.status }}" data-type="{{ job.type }}" data-created="{{ job.created_at }}">
                                            <td data-label="Status">
                                                <span class="status-badge {{ job.status }}">
                                                    {% if job.status == "running" %}
                                                        <i class="fas fa-spinner fa-spin"></i>
                                                    {% elif job.status == "completed" %}
                                                        <i class="fas fa-check-circle"></i>
                                                    {% elif job.status in ["failed", "error"] %}
                                                        <i class="fas fa-exclamation-circle"></i>
                                                    {% elif job.status == "cancelled" %}
                                                        <i class="fas fa-ban"></i>
                                                    {% else %}
                                                        <i class="fas fa-clock"></i>
                                                    {% endif %}
                                                    {{ job.status.title() }}
                                                </span>
                                            </td>
                                            <td data-label="Job ID">
                                                <code class="job-id-code">{{ job.id }}</code>
                                            </td>
                                            <td data-label="Type">
                                                <span class="job-type-badge {{ job.type }}">
                                                    {% if job.type == 'single' %}
                                                        <i class="fas fa-file-archive"></i> Single
                                                    {% else %}
                                                        <i class="fas fa-layer-group"></i> Batch
                                                    {% endif %}
                                                </span>
                                            </td>
                                            <td data-label="File(s)">
                                                {% if job.type == 'single' %}
                                                    <div class="file-info">
                                                        <i class="fas fa-file"></i>
                                                        <span title="{{ job.filename }}">{{ job.filename | truncate(25) }}</span>
                                                    </div>
                                                {% else %}
                                                    <div class="file-count">
                                                        <i class="fas fa-files"></i>
                                                        {{ job.file_count }} files
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td data-label="Engine">{{ job.engine }}</td>
                                            <td data-label="Created">{{ job.created_at | format_datetime }}</td>
                                            <td data-label="Duration">{{ job.created_at | format_duration(job.updated_at) }}</td>
                                            <td data-label="Progress">
                                                {% if job.status == "running" %}
                                                    <div class="table-progress">
                                                        <div class="progress-bar small">
                                                            <div class="progress" data-progress="{{ job.progress }}"></div>
                                                        </div>
                                                        <span class="progress-text">{{ job.progress }}%</span>
                                                    </div>
                                                {% elif job.type == 'batch' and job.status in ['completed', 'failed'] %}
                                                    <div class="batch-stats">
                                                        <span class="stat success">{{ job.get('completed', 0) }}</span>/
                                                        <span class="stat error">{{ job.get('failed', 0) }}</span>
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">—</span>
                                                {% endif %}
                                            </td>
                                            <td data-label="Actions">
                                                <div class="action-buttons">
                                                    <a href="{{ url_for('view_job', job_id=job.id) }}" class="btn primary small" title="View job details" aria-label="View job details">
                                                        <i class="fas fa-eye" aria-hidden="true"></i>
                                                        <span class="sr-only">View details</span>
                                                    </a>
                                                    
                                                    {% if job.status in ["running", "pending"] %}
                                                        <button class="btn danger small" onclick="cancelJob('{{ job.id }}')" title="Cancel job" aria-label="Cancel job">
                                                            <i class="fas fa-stop" aria-hidden="true"></i>
                                                            <span class="sr-only">Cancel</span>
                                                        </button>
                                                    {% elif job.status == "completed" and job.type == "single" %}
                                                        <a href="{{ url_for('compare_jobs') }}?job1={{ job.id }}" class="btn secondary small" title="Compare results" aria-label="Compare results">
                                                            <i class="fas fa-balance-scale" aria-hidden="true"></i>
                                                            <span class="sr-only">Compare</span>
                                                        </a>
                                                    {% endif %}
                                                    
                                                    {% if job.status not in ["running"] %}
                                                        <button class="btn danger small" onclick="deleteJob('{{ job.id }}')" title="Delete job" aria-label="Delete job">
                                                            <i class="fas fa-trash" aria-hidden="true"></i>
                                                            <span class="sr-only">Delete</span>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    
                    {% if jobs | length > 20 %}
                        <div class="pagination">
                            <button class="pagination-btn" onclick="previousPage()" id="prev-btn" disabled>
                                <i class="fas fa-chevron-left"></i>
                                Previous
                            </button>
                            <span class="pagination-info">
                                Page <span id="current-page">1</span> of <span id="total-pages">{{ (jobs | length / 20) | round(0, 'ceil') | int }}</span>
                            </span>
                            <button class="pagination-btn" onclick="nextPage()" id="next-btn">
                                Next
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    {% endif %}

                {% else %}
                    
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-inbox"></i>
                        </div>
                        <h2>No Analysis Jobs Found</h2>
                        <p>You haven't run any analysis jobs yet. Start by uploading an APK file for analysis.</p>
                        <div class="empty-actions">
                            <a href="/" class="btn primary">
                                <i class="fas fa-plus"></i>
                                Start New Analysis
                            </a>
                            <a href="/status" class="btn secondary">
                                <i class="fas fa-chart-line"></i>
                                Check System Status
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>

            
            <div class="quick-actions-section">
                <div class="section-header">
                    <h2><i class="fas fa-rocket"></i> Quick Actions</h2>
                </div>
                
                <div class="action-cards">
                    <a href="/" class="action-card">
                        <i class="fas fa-plus"></i>
                        <h3>New Single Analysis</h3>
                        <p>Analyze a single APK file</p>
                    </a>
                    
                    <a href="/?batch=true" class="action-card">
                        <i class="fas fa-layer-group"></i>
                        <h3>Batch Analysis</h3>
                        <p>Analyze multiple APK files</p>
                    </a>
                    
                    <a href="/compare" class="action-card">
                        <i class="fas fa-balance-scale"></i>
                        <h3>Compare Results</h3>
                        <p>Compare analysis results</p>
                    </a>
                    
                    <a href="/status" class="action-card">
                        <i class="fas fa-chart-line"></i>
                        <h3>System Status</h3>
                        <p>Monitor system health</p>
                    </a>
                </div>
            </div>
        </div>
    </main>

    
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>APASS ARYX</h3>
                    <p>Advanced APK Analysis Platform for comprehensive security assessment</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="/">Home</a></li>
                        <li><a href="/jobs">Job History</a></li>
                        <li><a href="/status">System Status</a></li>
                        <li><a href="/compare">Compare Results</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 APASS ARYX by Aiden Azad (V7lthronyx). All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Jobs page specific functionality
        let currentView = 'grid';
        let currentPage = 1;
        const itemsPerPage = 20;

        function toggleView(view) {
            const gridView = document.getElementById('grid-view');
            const tableView = document.getElementById('table-view');
            const viewButtons = document.querySelectorAll('.view-btn');

            viewButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-view="${view}"]`).classList.add('active');

            if (view === 'grid') {
                gridView.style.display = 'grid';
                tableView.style.display = 'none';
            } else {
                gridView.style.display = 'none';
                tableView.style.display = 'block';
            }

            currentView = view;
        }

        function toggleFilters() {
            const filtersSection = document.getElementById('filters-section');
            filtersSection.style.display = filtersSection.style.display === 'none' ? 'block' : 'none';
        }

        function applyFilters() {
            const statusFilter = document.getElementById('status-filter').value;
            const typeFilter = document.getElementById('type-filter').value;
            const dateFilter = document.getElementById('date-filter').value;

            const jobCards = document.querySelectorAll('.job-card, .job-row');
            
            jobCards.forEach(card => {
                let show = true;

                if (statusFilter && !card.dataset.status.includes(statusFilter)) {
                    show = false;
                }

                if (typeFilter && !card.dataset.type.includes(typeFilter)) {
                    show = false;
                }

                if (dateFilter) {
                    const cardDate = new Date(card.dataset.created);
                    const now = new Date();
                    let cutoff;

                    switch (dateFilter) {
                        case 'today':
                            cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            break;
                        case 'week':
                            cutoff = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            break;
                        case 'month':
                            cutoff = new Date(now.getFullYear(), now.getMonth(), 1);
                            break;
                    }

                    if (cutoff && cardDate < cutoff) {
                        show = false;
                    }
                }

                card.style.display = show ? '' : 'none';
            });
        }

        function clearFilters() {
            document.getElementById('status-filter').value = '';
            document.getElementById('type-filter').value = '';
            document.getElementById('date-filter').value = '';
            applyFilters();
        }

        function applySorting() {
            const sortBy = document.getElementById('sort-by').value;
            const container = currentView === 'grid' ? document.getElementById('grid-view') : document.getElementById('jobs-table-body');
            const items = Array.from(container.children);

            items.sort((a, b) => {
                switch (sortBy) {
                    case 'created_desc':
                        return new Date(b.dataset.created) - new Date(a.dataset.created);
                    case 'created_asc':
                        return new Date(a.dataset.created) - new Date(b.dataset.created);
                    case 'status':
                        return a.dataset.status.localeCompare(b.dataset.status);
                    case 'type':
                        return a.dataset.type.localeCompare(b.dataset.type);
                    default:
                        return 0;
                }
            });

            items.forEach(item => container.appendChild(item));
        }

        function refreshJobList() {
            location.reload();
        }

        function cancelJob(jobId) {
            if (!confirm('Cancel this job?')) return;
            fetch(`/api/jobs/${jobId}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                }
            })
            .then(async (response) => {
                const data = await response.json().catch(() => ({ success: false, error: 'Unexpected response' }));
                if (response.ok && data.success) {
                    location.reload();
                    return;
                }
                if (response.status === 409) {
                    alert(data.error || 'Job cannot be cancelled in its current state.');
                } else {
                    alert('Failed to cancel job: ' + (data.error || response.statusText));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to cancel job');
            });
        }

        function deleteJob(jobId) {
            if (!confirm('Delete this job? This cannot be undone.')) return;
            // Prefer DELETE alias; if blocked by proxies, fall back to POST delete endpoint
            fetch(`/api/jobs/${jobId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                }
            })
            .then(async (response) => {
                if (response.ok) return response.json();
                // Fallback attempt
                return fetch(`/api/job/${jobId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    }
                }).then(r => r.json());
            })
            .then(data => {
                if (data && data.success) {
                    location.reload();
                } else {
                    alert('Failed to delete job: ' + (data?.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete job');
            });
        }

        // Initialize progress bars
        document.addEventListener('DOMContentLoaded', function() {
            const progressBars = document.querySelectorAll('.progress[data-progress]');
            progressBars.forEach(bar => {
                const progress = bar.dataset.progress;
                bar.style.width = progress + '%';
            });
        });
    </script>
</body>
</html>
